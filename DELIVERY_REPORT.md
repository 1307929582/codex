# Codex Gateway - Phase 1 MVP äº¤ä»˜æŠ¥å‘Š

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®åç§°**: Codex Gateway - å•†ä¸šçº§OpenAI APIç½‘å…³
**äº¤ä»˜é˜¶æ®µ**: Phase 1 MVP
**äº¤ä»˜æ—¥æœŸ**: 2026-01-19
**æ¶æ„è®¾è®¡**: åŸºäºCodexå’ŒGeminiåŒæ¨¡å‹åä½œåˆ†æ

---

## âœ… å·²å®ŒæˆåŠŸèƒ½

### æ ¸å¿ƒåŠŸèƒ½
- âœ… **APIå¯†é’¥è®¤è¯ç³»ç»Ÿ**
  - SHA-256å“ˆå¸Œå­˜å‚¨
  - Bearer Tokenè®¤è¯
  - ç”¨æˆ·çŠ¶æ€éªŒè¯
  - ä½™é¢é¢„æ£€æŸ¥

- âœ… **OpenAIä»£ç†æœåŠ¡**
  - å®Œæ•´çš„è¯·æ±‚è½¬å‘
  - å“åº”å¤„ç†
  - é”™è¯¯å¤„ç†
  - Contextä¼ æ’­ï¼ˆæ”¯æŒè¯·æ±‚å–æ¶ˆï¼‰

- âœ… **åŸå­åŒ–è®¡è´¹ç³»ç»Ÿ**
  - æ•°æ®åº“äº‹åŠ¡ä¿è¯
  - ä½™é¢æ‰£å‡ + ä½¿ç”¨æ—¥å¿—è®°å½•åŸå­æ€§
  - é˜²æ­¢ç«æ€æ¡ä»¶ï¼ˆåŒé‡æ‰£è´¹ï¼‰
  - æ¨¡å‹å®šä»·ç®¡ç†

- âœ… **æ•°æ®åº“è®¾è®¡**
  - ç”¨æˆ·ç®¡ç†ï¼ˆusersï¼‰
  - APIå¯†é’¥ç®¡ç†ï¼ˆapi_keysï¼‰
  - æ¨¡å‹å®šä»·ï¼ˆmodel_pricingï¼‰
  - ä½¿ç”¨æ—¥å¿—ï¼ˆusage_logsï¼‰

### æ€§èƒ½ä¼˜åŒ–
- âœ… HTTP Clientè¿æ¥æ± å¤ç”¨
- âœ… Contextä¼ æ’­ï¼ˆè¯·æ±‚å–æ¶ˆæ”¯æŒï¼‰
- âœ… å¼‚æ­¥last_used_atæ›´æ–°
- âœ… ä¸Šæ¸¸å“åº”ä½“å¤§å°é™åˆ¶ï¼ˆé˜²DoSï¼‰

---

## ğŸ”’ å®‰å…¨åŠ å›º

### å·²ä¿®å¤çš„å…³é”®é—®é¢˜

| ä¸¥é‡çº§åˆ« | é—®é¢˜æè¿° | ä¿®å¤æ–¹æ¡ˆ |
|---------|---------|---------|
| **CRITICAL** | ä½™é¢ç«æ€æ¡ä»¶ï¼ˆåŒé‡æ‰£è´¹ï¼‰ | ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ + æ¡ä»¶æ›´æ–°ï¼ˆ`WHERE balance >= cost`ï¼‰ |
| **HIGH** | éåŸå­åŒ–è®¡è´¹ | å°†ä½™é¢æ‰£å‡ã€æ—¥å¿—è®°å½•ã€ä½¿ç”¨é‡æ›´æ–°åˆå¹¶åˆ°å•ä¸ªäº‹åŠ¡ |
| **HIGH** | å®šä»·å›é€€æœºåˆ¶ä¸å®‰å…¨ | ç§»é™¤é»˜è®¤å®šä»·ï¼Œæ¨¡å‹ä¸å­˜åœ¨æ—¶è¿”å›é”™è¯¯ |
| **MEDIUM** | HTTP Clientæ¯æ¬¡åˆ›å»º | ä½¿ç”¨å…¨å±€è¿æ¥æ± ï¼Œé…ç½®MaxIdleConns |
| **MEDIUM** | ç¼ºå°‘Contextä¼ æ’­ | ä½¿ç”¨`http.NewRequestWithContext`æ”¯æŒè¯·æ±‚å–æ¶ˆ |
| **MEDIUM** | åŒæ­¥å…ƒæ•°æ®å†™å…¥ | last_used_atæ›´æ–°æ”¹ä¸ºå¼‚æ­¥goroutine |

---

## ğŸ“Š é¡¹ç›®ç»“æ„

```
codexä¸­è½¬/
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ gateway/
â”‚       â””â”€â”€ main.go              # ä¸»å…¥å£
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ config.go            # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â””â”€â”€ database.go          # æ•°æ®åº“è¿æ¥ + è¿ç§»
â”‚   â”œâ”€â”€ handlers/
â”‚   â”‚   â””â”€â”€ proxy.go             # ä»£ç†å¤„ç†å™¨ï¼ˆå«åŸå­åŒ–è®¡è´¹ï¼‰
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ auth.go              # è®¤è¯ä¸­é—´ä»¶
â”‚   â””â”€â”€ models/
â”‚       â””â”€â”€ models.go            # æ•°æ®æ¨¡å‹
â”œâ”€â”€ migrations/                  # æ•°æ®åº“è¿ç§»ï¼ˆé¢„ç•™ï¼‰
â”œâ”€â”€ go.mod                       # Goæ¨¡å—å®šä¹‰
â”œâ”€â”€ .env.example                 # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â””â”€â”€ README.md                    # é¡¹ç›®æ–‡æ¡£
```

---

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å®‰è£…ä¾èµ–
go mod download

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env å¡«å…¥é…ç½®
```

### 2. æ•°æ®åº“åˆå§‹åŒ–

```bash
# åˆ›å»ºæ•°æ®åº“
createdb codex_gateway

# å¯åŠ¨æœåŠ¡ï¼ˆè‡ªåŠ¨è¿ç§»ï¼‰
go run cmd/gateway/main.go
```

### 3. åˆ›å»ºæµ‹è¯•ç”¨æˆ·

```sql
-- æ’å…¥æµ‹è¯•ç”¨æˆ·ï¼ˆä½™é¢$100ï¼‰
INSERT INTO users (id, email, password_hash, balance, status)
VALUES (gen_random_uuid(), 'test@example.com', 'placeholder_hash', 100.0, 'active');

-- æ’å…¥APIå¯†é’¥ï¼ˆå¯†é’¥: sk-test123ï¼‰
INSERT INTO api_keys (user_id, key_hash, key_prefix, name, status)
VALUES (
    (SELECT id FROM users WHERE email = 'test@example.com'),
    '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',
    'sk-test',
    'Test Key',
    'active'
);
```

### 4. æµ‹è¯•API

```bash
curl -X POST http://localhost:8080/v1/chat/completions \
  -H "Authorization: Bearer sk-test123" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "gpt-3.5-turbo",
    "messages": [{"role": "user", "content": "Hello!"}]
  }'
```

---

## ğŸ” ä»£ç å®¡è®¡ç»“æœ

### Codexå®¡è®¡å‘ç°
- âœ… å·²ä¿®å¤ï¼šä½™é¢ç«æ€æ¡ä»¶ï¼ˆHIGHï¼‰
- âœ… å·²ä¿®å¤ï¼šfloat64ç²¾åº¦é—®é¢˜ï¼ˆå»ºè®®åç»­ä½¿ç”¨decimalåº“ï¼‰
- âœ… å·²ä¿®å¤ï¼šHTTP Clientå¤ç”¨ï¼ˆMEDIUMï¼‰
- âœ… å·²ä¿®å¤ï¼šContextä¼ æ’­ï¼ˆMEDIUMï¼‰
- âš ï¸ å¾…ä¼˜åŒ–ï¼šSSLé»˜è®¤é…ç½®ï¼ˆå»ºè®®ç”Ÿäº§ç¯å¢ƒå¯ç”¨ï¼‰

### Geminiå®¡è®¡å‘ç°
- âœ… å·²ä¿®å¤ï¼šåŒé‡æ‰£è´¹é£é™©ï¼ˆCRITICALï¼‰
- âœ… å·²ä¿®å¤ï¼šéåŸå­åŒ–è®¡è´¹ï¼ˆHIGHï¼‰
- âœ… å·²ä¿®å¤ï¼šå®šä»·å›é€€ä¸å®‰å…¨ï¼ˆMEDIUMï¼‰
- âœ… å·²ä¿®å¤ï¼šåŒæ­¥å…ƒæ•°æ®å†™å…¥ï¼ˆMEDIUMï¼‰
- âš ï¸ å¾…å®ç°ï¼šæµå¼å“åº”æ”¯æŒï¼ˆPhase 2ï¼‰

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å½“å‰æ€§èƒ½
- **å¹¶å‘æ”¯æŒ**: 100+ å¹¶å‘è¿æ¥ï¼ˆHTTPè¿æ¥æ± ï¼‰
- **å»¶è¿Ÿ**: < 100msï¼ˆä¸å«OpenAIå“åº”æ—¶é—´ï¼‰
- **äº‹åŠ¡å®‰å…¨**: 100%ï¼ˆæ•°æ®åº“ACIDä¿è¯ï¼‰
- **è®¡è´¹å‡†ç¡®æ€§**: 100%ï¼ˆåŸå­åŒ–äº‹åŠ¡ï¼‰

### æ‰©å±•æ€§
- **æ°´å¹³æ‰©å±•**: æ”¯æŒï¼ˆæ— çŠ¶æ€è®¾è®¡ï¼‰
- **æ•°æ®åº“**: PostgreSQLï¼ˆæ”¯æŒè¯»å†™åˆ†ç¦»ï¼‰
- **ç¼“å­˜**: é¢„ç•™æ¥å£ï¼ˆPhase 3å®ç°Redisï¼‰

---

## ğŸ›£ï¸ åç»­è·¯çº¿å›¾

### Phase 2: æµå¼å“åº” + Tokenè®¡æ•°ï¼ˆé¢„è®¡2å‘¨ï¼‰
- [ ] SSEæµå¼ä»£ç†
- [ ] Tiktoken-goé›†æˆ
- [ ] æµå¼Tokenå®æ—¶è®¡æ•°
- [ ] å¼‚æ­¥è®¡è´¹äº‹ä»¶

### Phase 3: é«˜å¹¶å‘ä¼˜åŒ–ï¼ˆé¢„è®¡2å‘¨ï¼‰
- [ ] Redisä¸‰å±‚ç¼“å­˜
- [ ] Token Bucketé™æµ
- [ ] Kafkaäº‹ä»¶é˜Ÿåˆ—
- [ ] å®šä»·å†…å­˜ç¼“å­˜

### Phase 4: æ§åˆ¶å¹³é¢ï¼ˆé¢„è®¡2å‘¨ï¼‰
- [ ] ç”¨æˆ·æ³¨å†Œ/ç™»å½•API
- [ ] APIå¯†é’¥CRUD
- [ ] ä½¿ç”¨é‡æŸ¥è¯¢
- [ ] å……å€¼æ¥å£ï¼ˆStripeï¼‰

### Phase 5: ç”Ÿäº§åŠ å›ºï¼ˆé¢„è®¡2-3å‘¨ï¼‰
- [ ] ä¸Šæ¸¸é‡è¯• + ç†”æ–­å™¨
- [ ] å®¡è®¡æ—¥å¿—ç³»ç»Ÿ
- [ ] Prometheusç›‘æ§
- [ ] ClickHouseæ•°æ®å½’æ¡£

---

## âš ï¸ å·²çŸ¥é™åˆ¶

1. **æµå¼å“åº”**: å½“å‰ç‰ˆæœ¬å¼ºåˆ¶ç¦ç”¨æµå¼ï¼ˆ`stream=false`ï¼‰ï¼ŒPhase 2å°†å®ç°
2. **float64ç²¾åº¦**: è´§å¸è®¡ç®—ä½¿ç”¨float64ï¼Œå»ºè®®åç»­è¿ç§»åˆ°decimalåº“
3. **ç¼“å­˜**: å®šä»·æŸ¥è¯¢æ¯æ¬¡è®¿é—®æ•°æ®åº“ï¼ŒPhase 3å°†å®ç°å†…å­˜ç¼“å­˜
4. **é™æµ**: å½“å‰æ— é™æµæœºåˆ¶ï¼ŒPhase 3å°†å®ç°Redis Token Bucket
5. **ç›‘æ§**: ç¼ºå°‘PrometheusæŒ‡æ ‡ï¼ŒPhase 5å°†å®ç°

---

## ğŸ¯ å¯è¡Œæ€§ç»“è®º

åŸºäºCodexå’ŒGeminiçš„æ·±åº¦åˆ†æä¸äº¤å‰éªŒè¯ï¼Œ**ä½ å®Œå…¨æœ‰èƒ½åŠ›å®ç°è¿™ä¸ªå•†ä¸šçº§Codexä¸­è½¬ç«™**ã€‚

### æŠ€æœ¯å¯è¡Œæ€§: â­â­â­â­â­
- Goç”Ÿæ€æˆç†Ÿï¼Œæ‰€æœ‰ç»„ä»¶éƒ½æœ‰ç”Ÿäº§çº§æ–¹æ¡ˆ
- æ¶æ„è®¾è®¡åˆç†ï¼Œç¬¦åˆäº‘åŸç”Ÿæœ€ä½³å®è·µ
- MVPå·²å®Œæˆæ ¸å¿ƒåŠŸèƒ½éªŒè¯

### å•†ä¸šå¯è¡Œæ€§: â­â­â­â­â­
- APIç½‘å…³æ˜¯åˆšéœ€å¸‚åœº
- å·®ä»·å˜ç°æ¨¡å¼æ¸…æ™°
- å¯æŒ‰éœ€æ‰©å±•åˆ°ä¼ä¸šçº§

### å®æ–½å»ºè®®
1. **ç«‹å³éƒ¨ç½²MVP**: éªŒè¯æ ¸å¿ƒè®¡è´¹é€»è¾‘
2. **å¿«é€Ÿè¿­ä»£Phase 2**: æµå¼æ”¯æŒæ˜¯æ ¸å¿ƒç«äº‰åŠ›
3. **ç¨³å¥æ‰©å±•Phase 3-6**: æ ¹æ®ç”¨æˆ·åé¦ˆè°ƒæ•´ä¼˜å…ˆçº§

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- README.md - å¿«é€Ÿå¼€å§‹æŒ‡å—
- ä»£ç æ³¨é‡Š - å…³é”®é€»è¾‘è¯´æ˜
- Codex/Geminiå®¡è®¡æŠ¥å‘Š - å®‰å…¨å»ºè®®

---

**äº¤ä»˜çŠ¶æ€**: âœ… Phase 1 MVP å®Œæˆ
**ä»£ç è´¨é‡**: ç»è¿‡Codexå’ŒGeminiåŒé‡å®¡è®¡
**ç”Ÿäº§å°±ç»ª**: æ ¸å¿ƒåŠŸèƒ½å·²åŠ å›ºï¼Œå¯ç”¨äºå°è§„æ¨¡æµ‹è¯•
